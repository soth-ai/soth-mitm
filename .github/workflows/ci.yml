name: soth-mitm-ci

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

jobs:
  feature_matrix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Check default feature set
        run: cargo check --workspace

      - name: Check OpenSSL backend feature path
        run: cargo check -p mitm-tls --features openssl-backend

  fmt_clippy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          components: rustfmt, clippy

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Enforce max file length
        run: ./scripts/check_max_file_lines.sh

      - name: Check formatting
        run: cargo fmt --all --check

      - name: Lint
        run: cargo clippy --workspace --all-targets -- -D warnings

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run workspace tests
        run: cargo test --workspace

  phase_a_smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run Phase A smoke harness
        run: ./scripts/phase_a_smoke.sh

  tls_failure_fixtures:
    name: tls_failure_fixtures
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run TLS failure fixture harness
        run: ./scripts/tls_failure_fixtures.sh --report-dir artifacts/tls-failure-fixtures

      - name: Upload TLS failure fixture artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tls-failure-fixtures
          path: artifacts/tls-failure-fixtures
          if-no-files-found: error

  p1_reliability:
    name: p1_reliability (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run Phase 1 reliability suite
        run: ./scripts/p1_reliability.sh

      - name: Upload Phase 1 reliability report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p1-reliability-${{ matrix.os }}
          path: artifacts/p1-reliability
          if-no-files-found: error

  phase2_protocol_matrix:
    name: phase2_protocol_matrix (${{ matrix.lane }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        lane:
          - http2
          - websocket
          - sse
          - http3_passthrough
          - grpc_http2
          - msgpack
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run Phase 2 protocol lane
        run: ./scripts/p2_protocol_gate.sh --lane ${{ matrix.lane }} --report-dir artifacts/p2-protocol/${{ matrix.lane }}

      - name: Upload Phase 2 lane artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p2-protocol-${{ matrix.lane }}
          path: artifacts/p2-protocol/${{ matrix.lane }}
          if-no-files-found: error

  phase2_protocol_triage:
    name: phase2_protocol_triage
    runs-on: ubuntu-latest
    needs:
      - phase2_protocol_matrix
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Phase 2 lane artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: p2-protocol-*
          path: artifacts/p2-protocol
          merge-multiple: true

      - name: Build triage summary
        run: ./scripts/p2_protocol_triage.sh --input-root artifacts/p2-protocol --output-dir artifacts/p2-protocol/triage

      - name: Upload Phase 2 triage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p2-protocol-triage
          path: artifacts/p2-protocol/triage
          if-no-files-found: error

  phase4_differential_validation:
    name: phase4_differential_validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run differential validation suite
        run: ./scripts/p4_differential_validation.sh --report-dir artifacts/p4-differential

      - name: Upload differential validation artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p4-differential
          path: artifacts/p4-differential
          if-no-files-found: error

  phase4_performance_gates:
    name: phase4_performance_gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run performance gates
        run: ./scripts/p4_performance_gates.sh --report-dir artifacts/p4-performance

      - name: Upload performance gate artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p4-performance
          path: artifacts/p4-performance
          if-no-files-found: error

  phase4_failure_injection:
    name: phase4_failure_injection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run failure injection suite
        run: ./scripts/p4_failure_injection.sh --report-dir artifacts/p4-failure-injection

      - name: Upload failure injection artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p4-failure-injection
          path: artifacts/p4-failure-injection
          if-no-files-found: error

  phase4_tool_lanes:
    name: phase4_tool_lanes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run tool lanes (non-strict)
        run: ./scripts/p4_tool_lanes.sh --skip-network --report-dir artifacts/p4-tool-lanes

      - name: Upload tool lane artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p4-tool-lanes
          path: artifacts/p4-tool-lanes
          if-no-files-found: error

  phase4_chaos_network_faults:
    name: phase4_chaos_network_faults
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run chaos network fault lane
        run: ./scripts/p4_chaos_network_faults.sh --report-dir artifacts/p4-chaos-network

      - name: Upload chaos network fault artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p4-chaos-network
          path: artifacts/p4-chaos-network
          if-no-files-found: error

  phase4_chaos_adversarial:
    name: phase4_chaos_adversarial
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run chaos and adversarial suite
        run: ./scripts/p4_chaos_adversarial.sh --report-dir artifacts/p4-chaos

      - name: Upload chaos and adversarial artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p4-chaos
          path: artifacts/p4-chaos
          if-no-files-found: error
