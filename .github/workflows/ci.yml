name: soth-mitm-ci

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      run_profile:
        description: "CI profile to run"
        required: true
        type: choice
        options:
          - fast
          - full
        default: fast

permissions:
  contents: read

jobs:
  feature_matrix:
    name: feature_matrix (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Check default feature set
        run: cargo check --workspace

      - name: Check all feature set (non-Windows)
        if: runner.os != 'Windows'
        run: cargo check --workspace --all-features

      - name: Check all feature set (Windows sans OpenSSL backend)
        if: runner.os == 'Windows'
        run: cargo check --workspace --all-features --exclude mitm-tls

      - name: Check OpenSSL backend feature path (non-Windows)
        if: runner.os != 'Windows'
        run: cargo check -p mitm-tls --features openssl-backend

  fmt_clippy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.88.0
        with:
          components: rustfmt, clippy

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Enforce max file length
        run: ./scripts/check_max_file_lines.sh

      - name: Check formatting
        run: cargo fmt --all --check

      - name: Lint (default features smell scan)
        run: cargo clippy --workspace --all-targets -- -W clippy::all

      - name: Lint (all features smell scan)
        run: cargo clippy --workspace --all-targets --all-features -- -W clippy::all

  compliance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-deny
        if: runner.os != 'Windows'
        uses: taiki-e/install-action@cargo-deny

      - name: Install cargo-audit
        uses: taiki-e/install-action@cargo-audit

      - name: Install cargo-machete
        uses: taiki-e/install-action@cargo-machete

      - name: Enforce dependency policy
        run: cargo deny check bans licenses sources

      - name: Audit dependencies
        run: cargo audit

      - name: Check for unused dependencies
        run: cargo machete

      - name: Enforce prohibition policy
        run: ./scripts/check_prohibitions.sh

  test:
    name: test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run workspace tests
        run: cargo test --workspace

  phase_a_smoke:
    name: phase_a_smoke (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run Phase A smoke harness
        shell: bash
        run: ./scripts/phase_a_smoke.sh

  tls_failure_fixtures:
    name: tls_failure_fixtures (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run TLS failure fixture harness
        shell: bash
        run: ./scripts/tls_failure_fixtures.sh --report-dir artifacts/tls-failure-fixtures/${{ matrix.os }}

      - name: Upload TLS failure fixture artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: tls-failure-fixtures-${{ matrix.os }}
          path: artifacts/tls-failure-fixtures/${{ matrix.os }}
          if-no-files-found: error

  p1_reliability:
    name: p1_reliability (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run Phase 1 reliability suite
        shell: bash
        run: ./scripts/p1_reliability.sh

      - name: Upload Phase 1 reliability report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: p1-reliability-${{ matrix.os }}
          path: artifacts/p1-reliability
          if-no-files-found: error

  phase2_protocol_matrix:
    name: phase2_protocol_matrix (${{ matrix.os }} / ${{ matrix.lane }})
    if: >-
      ${{
        github.event_name == 'push' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.run_profile == 'full')
      }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
        lane:
          - http2
          - websocket
          - sse
          - http3_passthrough
          - grpc_http2
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run Phase 2 protocol lane
        shell: bash
        run: ./scripts/p2_protocol_gate.sh --lane ${{ matrix.lane }} --report-dir artifacts/p2-protocol/${{ matrix.os }}/${{ matrix.lane }}

      - name: Upload Phase 2 lane artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: p2-protocol-${{ matrix.os }}-${{ matrix.lane }}
          path: artifacts/p2-protocol/${{ matrix.os }}/${{ matrix.lane }}
          if-no-files-found: error

  phase2_protocol_triage:
    name: phase2_protocol_triage
    if: >-
      ${{
        github.event_name == 'push' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.run_profile == 'full')
      }}
    runs-on: ubuntu-latest
    needs:
      - phase2_protocol_matrix
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download Phase 2 lane artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: p2-protocol-*
          path: artifacts/p2-protocol
          # Keep each uploaded artifact in its own directory so status.tsv files
          # do not overwrite each other during download.
          merge-multiple: false

      - name: Build triage summary
        run: ./scripts/p2_protocol_triage.sh --input-root artifacts/p2-protocol --output-dir artifacts/p2-protocol/triage

      - name: Upload Phase 2 triage artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: p2-protocol-triage
          path: artifacts/p2-protocol/triage
          if-no-files-found: error

  phase4_differential_validation:
    name: phase4_differential_validation (${{ matrix.os }})
    if: >-
      ${{
        github.event_name == 'push' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.run_profile == 'full')
      }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run differential validation suite
        shell: bash
        run: ./scripts/p4_differential_validation.sh --report-dir artifacts/p4-differential/${{ matrix.os }}

      - name: Upload differential validation artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: p4-differential-${{ matrix.os }}
          path: artifacts/p4-differential/${{ matrix.os }}
          if-no-files-found: error

  phase4_performance_gates:
    name: phase4_performance_gates (${{ matrix.os }})
    if: >-
      ${{
        github.event_name == 'push' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.run_profile == 'full')
      }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run performance gates
        shell: bash
        run: ./scripts/p4_performance_gates.sh --report-dir artifacts/p4-performance/${{ matrix.os }}

      - name: Upload performance gate artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: p4-performance-${{ matrix.os }}
          path: artifacts/p4-performance/${{ matrix.os }}
          if-no-files-found: error

  phase4_failure_injection:
    name: phase4_failure_injection (${{ matrix.os }})
    if: >-
      ${{
        github.event_name == 'push' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.run_profile == 'full')
      }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run failure injection suite
        shell: bash
        run: ./scripts/p4_failure_injection.sh --report-dir artifacts/p4-failure-injection/${{ matrix.os }}

      - name: Upload failure injection artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: p4-failure-injection-${{ matrix.os }}
          path: artifacts/p4-failure-injection/${{ matrix.os }}
          if-no-files-found: error

  phase4_tool_lanes:
    name: phase4_tool_lanes (${{ matrix.os }})
    if: >-
      ${{
        github.event_name == 'push' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.run_profile == 'full')
      }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run tool lanes (non-strict)
        shell: bash
        run: ./scripts/p4_tool_lanes.sh --skip-network --report-dir artifacts/p4-tool-lanes/${{ matrix.os }}

      - name: Upload tool lane artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: p4-tool-lanes-${{ matrix.os }}
          path: artifacts/p4-tool-lanes/${{ matrix.os }}
          if-no-files-found: error

  phase4_chaos_network_faults:
    name: phase4_chaos_network_faults (${{ matrix.os }})
    if: >-
      ${{
        github.event_name == 'push' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.run_profile == 'full')
      }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run chaos network fault lane
        shell: bash
        run: ./scripts/p4_chaos_network_faults.sh --report-dir artifacts/p4-chaos-network/${{ matrix.os }}

      - name: Upload chaos network fault artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: p4-chaos-network-${{ matrix.os }}
          path: artifacts/p4-chaos-network/${{ matrix.os }}
          if-no-files-found: error

  phase4_chaos_adversarial:
    name: phase4_chaos_adversarial (${{ matrix.os }})
    if: >-
      ${{
        github.event_name == 'push' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.run_profile == 'full')
      }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run chaos and adversarial suite
        shell: bash
        run: ./scripts/p4_chaos_adversarial.sh --report-dir artifacts/p4-chaos/${{ matrix.os }}

      - name: Upload chaos and adversarial artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: p4-chaos-${{ matrix.os }}
          path: artifacts/p4-chaos/${{ matrix.os }}
          if-no-files-found: error

  phase6_performance_gates:
    name: phase6_performance_gates (${{ matrix.os }})
    if: >-
      ${{
        github.event_name == 'push' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.run_profile == 'full')
      }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Run phase 6 performance gates
        shell: bash
        env:
          P6_FORWARD_P99_US: ${{ runner.os == 'Windows' && '25000' || '15000' }}
        run: ./scripts/p6_perf_gate.sh --report-dir artifacts/p6-performance/${{ matrix.os }}

      - name: Upload phase 6 performance artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: p6-performance-${{ matrix.os }}
          path: artifacts/p6-performance/${{ matrix.os }}
          if-no-files-found: error

  phase6_acceptance_matrix:
    name: phase6_acceptance_matrix (${{ matrix.os }})
    if: >-
      ${{
        github.event_name == 'push' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.run_profile == 'full')
      }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-deny
        if: runner.os != 'Windows'
        uses: taiki-e/install-action@cargo-deny

      - name: Run phase 6 acceptance matrix
        shell: bash
        run: ./scripts/p6_acceptance_matrix.sh --report-dir artifacts/p6-acceptance/${{ matrix.os }}

      - name: Upload phase 6 acceptance artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: p6-acceptance-${{ matrix.os }}
          path: artifacts/p6-acceptance/${{ matrix.os }}
          if-no-files-found: error
